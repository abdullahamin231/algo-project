import argparse
import json
from pathlib import Path

import matplotlib.pyplot as plt

from run_experiments_common import TIME_METRIC_KEYS, print_results_table


def plot_results(results, output_path: Path):
    structures = [name for name in ("BST", "Treap") if name in results]
    if not structures:
        raise ValueError("No structures found in the metrics file.")

    fig, axes = plt.subplots(1, 2, figsize=(12, 5))
    x = range(len(structures))
    width = 0.25

    for idx, metric in enumerate(TIME_METRIC_KEYS):
        offsets = [pos + width * (idx - 1) for pos in x]
        axes[0].bar(
            offsets,
            [results[name][metric] for name in structures],
            width=width,
            label=metric,
        )
    axes[0].set_xticks(list(x))
    axes[0].set_xticklabels(structures)
    axes[0].set_ylabel("Seconds")
    axes[0].set_title("Average Operation Time")
    axes[0].legend()

    axes[1].bar(x, [results[name]["Height of the Tree"] for name in structures], width=width, label="Height")
    axes[1].bar(
        [pos + width for pos in x],
        [results[name]["Tree Balancing Factor"] for name in structures],
        width=width,
        label="Balancing Factor",
    )
    axes[1].set_xticks([pos + width / 2 for pos in x])
    axes[1].set_xticklabels(structures)
    axes[1].set_ylabel("Value")
    axes[1].set_title("Structural Metrics")
    axes[1].legend()

    fig.tight_layout()
    axes_path = output_path
    fig.savefig(axes_path, dpi=200, bbox_inches="tight")
    plt.close(fig)
    return axes_path


def main():
    parser = argparse.ArgumentParser(description="Plot the metrics generated by run_experiments_create.py.")
    parser.add_argument("--metrics-file", required=True, help="Path to the JSON file produced by the creation script.")
    parser.add_argument(
        "--output-file",
        type=str,
        default="results/benchmark.png",
        help="File path where the visualization image will be written.",
    )
    args = parser.parse_args()

    metrics_path = Path(args.metrics_file)
    if not metrics_path.exists():
        raise FileNotFoundError(f"Metrics file does not exist: {metrics_path}")

    with open(metrics_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    results = data.get("results", {})
    metadata = data.get("metadata", {})
    print("Experiment metadata:")
    for key, value in metadata.items():
        print(f"  {key}: {value}")

    structures = [name for name in ("BST", "Treap") if name in results]
    print_results_table(results, structures)

    output_path = Path(args.output_file)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    plot_path = plot_results(results, output_path)
    print(f"\nVisualization saved to {plot_path}")


if __name__ == "__main__":
    main()
